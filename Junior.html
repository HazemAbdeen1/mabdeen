<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Paints | دليل الألوان والمطابقات الهندسية الفاخرة</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons (for modern look) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* General styling and font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light background */
        }
        /* Tailwind custom configuration */
        .color-swatch-large {
            width: 100%;
            height: 180px;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #ddd;
        }
        .color-swatch-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar styling for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Sticky comparison bar definition */
        .sticky-comparison {
            position: sticky;
            top: 0;
            z-index: 40;
            /* Start hidden, only visible when colors are added */
            opacity: 0; 
            transform: translateY(-100%);
            transition: all 0.5s ease-out;
        }
        .sticky-comparison.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Engineer Search input styling */
        .search-input-segment {
             width: 100%;
             padding: 0.75rem;
             text-align: center;
             border: 1px solid #d1d5db;
             border-radius: 0.5rem;
             font-family: monospace;
             font-size: 1.1rem;
        }
        /* Comparison Item Styles (Increased height to 160px) */
        .comparison-swatch {
            min-height: 160px; /* INCREASED HEIGHT */
            flex-grow: 1; 
            min-width: 0; 
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        .comparison-details {
            position: absolute;
            top: 0; 
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.4); /* Dark overlay for readability */
            color: white;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Push content to the bottom */
            text-align: right;
        }
        .comparison-swatch:hover .comparison-details {
            opacity: 1; /* Show details on hover */
        }

        /* Style for the list of usages in the modal */
        .usage-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            margin-left: 0.5rem; /* ml-2 */
            margin-bottom: 0.5rem;
        }
        .usage-interior { background-color: #e0f2fe; color: #0284c7; } /* light blue */
        .usage-exterior { background-color: #fef3c7; color: #d97706; } /* light yellow/orange */
        .usage-wood { background-color: #ffe4e6; color: #ef4444; } /* light red */
        .usage-metal { background-color: #e5e7eb; color: #4b5563; } /* light gray */
        .usage-specialty { background-color: #f3e8ff; color: #a855f7; } /* light purple */
    </style>
</head>
<body dir="rtl">
    <!-- Mandatory Firebase Setup (Architecture Requirement) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Attempt sign-in only if not already signed in
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                             await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        } else {
            console.warn("Firebase config not available. Running without database persistence.");
        }
        // Expose necessary variables to the global scope for use in the script below
        window.db = db;
        window.auth = auth;
        window.getUserId = () => userId || crypto.randomUUID();
    </script>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen bg-gray-50">
        <!-- Logo Placeholder and App Title -->
        <div class="container mx-auto p-4 pt-6 text-center">
            <div id="logo-placeholder" class="h-20 flex items-center justify-center bg-gray-100 rounded-xl mb-4 border-4 border-dashed border-gray-300">
                <span class="text-gray-500 font-semibold text-lg">مكان شعار Junior Paints هنا (160x80)</span>
            </div>
            <h1 class="text-3xl font-extrabold text-[#264765] sm:text-4xl">Junior Paints</h1>
            <p class="text-lg text-gray-600 mt-1 mb-6">دليل الألوان والمطابقات الهندسية الفاخرة</p>
        </div>

        <!-- Header/Action Bar -->
        <header class="bg-white text-white p-4 shadow-lg border-b-2 border-[#349bca]">
            <div class="container mx-auto flex justify-center sm:justify-between items-center flex-wrap gap-4">
                <div class="flex space-x-4 space-x-reverse flex-wrap justify-center">
                    <button onclick="toggleModal('engineer-search-modal')" class="flex items-center bg-[#264765] hover:bg-[#349bca] text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md text-sm sm:text-base">
                        <i data-lucide="compass" class="w-5 h-5 ml-2"></i>
                        بحث المهندسين / Engineer Search
                    </button>
                    <button onclick="toggleModal('coverage-info-modal')" class="flex items-center bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md text-sm sm:text-base">
                        <i data-lucide="ruler" class="w-5 h-5 ml-2"></i>
                        معلومات التغطية / Coverage Info
                    </button>
                    <button onclick="toggleModal('contact-modal')" class="flex items-center bg-[#349bca] hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md text-sm sm:text-base">
                        <i data-lucide="phone" class="w-5 h-5 ml-2"></i>
                        اتصل بنا / Contact Us
                    </button>
                </div>
            </div>
        </header>

        <!-- Sticky Color Comparison Bar (FIXED and BIGGER) -->
        <div id="comparison-bar" class="sticky-comparison w-full bg-gray-100 border-b-4 border-gray-400 p-4 pt-6 shadow-xl">
            <div class="container mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-700 text-right">
                        مقارنة الألوان (حد أقصى 3) / Color Comparison (Max 3)
                    </h2>
                    <!-- NEW: Clear Comparison Button -->
                    <button id="clear-comparison-btn" onclick="clearComparison()" class="flex items-center text-sm font-semibold text-red-600 hover:text-red-800 transition duration-300 disabled:opacity-50">
                        <i data-lucide="x-octagon" class="w-4 h-4 ml-1"></i>
                        مسح المقارنة
                    </button>
                </div>
                
                <!-- Comparison Swatch Container: Occupies full width, no gaps -->
                <div id="comparison-swatch-container" class="flex w-full min-h-24 rounded-xl overflow-hidden shadow-2xl border-2 border-gray-300 relative">
                     <!-- Placeholder visible when 0 colors selected -->
                    <p id="comparison-placeholder" class="text-base text-gray-500 w-full flex items-center justify-center p-6 text-center bg-white absolute inset-0 z-10">
                        اضغط على زر "أضف للمقارنة" لإضافة الألوان / Click 'Compare' to add colors.
                    </p>
                    <!-- Selected colors will be injected here, over the placeholder -->
                </div>
            </div>
        </div>

        <!-- Filters and Color Grid -->
        <main class="container mx-auto p-4 pt-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Color Family Filter -->
                <div class="col-span-1">
                    <label for="color-family-filter" class="block text-sm font-medium text-gray-700 mb-1">
                        عائلة اللون / Color Family
                    </label>
                    <select id="color-family-filter" onchange="applyFilters()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <!-- Usage Filter -->
                <div class="col-span-1">
                    <label for="usage-filter" class="block text-sm font-medium text-gray-700 mb-1">
                        استخدام اللون / Color Usage
                    </label>
                    <select id="usage-filter" onchange="applyFilters()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Color Swatch Grid -->
            <div id="color-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- Colors will be injected here -->
            </div>
            <div id="no-results" class="hidden text-center text-xl text-gray-500 py-12">
                لا توجد نتائج مطابقة لمرشحاتك. / No matching colors found for your filters.
            </div>
        </main>
    </div>

    <!-- MODALS (unchanged) -->

    <!-- 1. Coverage Information Modal -->
    <div id="coverage-info-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-transform duration-300 scale-95 md:scale-100" role="dialog" aria-modal="true">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-[#264765]">معلومات تغطية الدهان والمعجون / Paint & Putty Coverage</h3>
                <button onclick="toggleModal('coverage-info-modal')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4 text-gray-700 overflow-y-auto max-h-[70vh]" dir="rtl">

                <h4 class="font-semibold text-lg text-[#349bca]">دهانات مائية (Water Based Paints)</h4>
                <ul class="list-disc pr-5 space-y-1 text-sm">
                    <li><strong>الاستخدام:</strong> داخلي وأحياناً خارجي. مثالية للتشطيبات الأساسية، قابلة للغسل، وسريعة الجفاف.</li>
                    <li><strong>تغطية الجالون (3.78 لتر):</strong> تصل إلى 40-50 متر مربع للطبقة الواحدة.</li>
                    <li><strong>ملاحظة:</strong> قد تقل التغطية على الأسطح الخشنة أو التي تتمتع بامتصاص عالي.</li>
                </ul>
                
                <h4 class="font-semibold text-lg text-[#264765] pt-3 border-t">دهانات زيتية (Oil Based Paints)</h4>
                <ul class="list-disc pr-5 space-y-1 text-sm">
                    <li><strong>الاستخدام:</strong> خارجي، خشب، أو معدن. توفر متانة أعلى ومقاومة ممتازة للرطوبة والعوامل الجوية.</li>
                    <li><strong>تغطية الجالون (3.78 لتر):</strong> تصل إلى 35-45 متر مربع للطبقة الواحدة.</li>
                    <li><strong>ملاحظة:</strong> تستخدم للأسطح التي تتطلب حماية إضافية وعادة ما تحتاج لوقت أطول للجفاف.</li>
                </ul>

                <h4 class="font-semibold text-lg text-red-600 pt-3 border-t">معجون (Putty Coverage)</h4>
                <ul class="list-disc pr-5 space-y-1 text-sm">
                    <li><strong>الاستخدام:</strong> تسوية وتنعيم الأسطح الداخلية قبل الدهان.</li>
                    <li><strong>تغطية الجالون (3.78 لتر):</strong> يغطي حوالي 15-25 متر مربع للطبقتين (الحد الأقصى).</li>
                    <li><strong>ملاحظة:</strong> تختلف التغطية بشكل كبير بناءً على مدى تسوية الجدار وعدد العيوب التي يتم ملؤها.</li>
                </ul>
                
                <p class="text-sm italic text-gray-500 mt-4 border-t pt-3">
                    تعتمد هذه التقديرات على الظروف المثالية وقد تتغير.
                </p>
            </div>
        </div>
    </div>

    <!-- 2. Contact Us Modal -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-transform duration-300 scale-95 md:scale-100" role="dialog" aria-modal="true">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-[#264765]">اتصل بنا / Contact Us</h3>
                <button onclick="toggleModal('contact-modal')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4 text-gray-700" dir="rtl">
                <a href="tel:+966555123456" class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition duration-150">
                    <i data-lucide="phone-call" class="w-6 h-6 ml-3 text-blue-600"></i>
                    <span class="font-semibold">+966 555 123 456</span>
                    <span class="mr-auto text-sm text-gray-500">هاتف / Phone</span>
                </a>
                <a href="https://wa.me/966555123456" target="_blank" class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition duration-150 bg-green-50">
                    <!-- WhatsApp Icon (Inline SVG to avoid external image URL) -->
                    <svg viewBox="0 0 24 24" width="24" height="24" class="ml-3 text-green-600 fill-current">
                        <path d="M12 2C6.477 2 2 6.477 2 12c0 1.5.39 2.92.94 4.17l-.87 3.23a1 1 0 001.24 1.24l3.23-.87C9.08 21.61 10.5 22 12 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm3.32 14.38c-.2-.09-.94-.47-1.08-.52-.14-.05-.24-.07-.35.06-.11.13-.42.52-.52.63-.1.11-.21.12-.39.06s-.79-.29-1.5-1.1c-.56-.67-.93-1.49-1.04-1.67-.11-.18-.01-.28.08-.37.08-.09.18-.2.27-.3.09-.1.12-.17.18-.28.06-.11.03-.2-.01-.28-.04-.08-.35-.84-.48-1.14-.13-.3-.26-.26-.35-.26-.08 0-.17-.01-.26-.01s-.24.04-.37.19c-.13.15-.5.48-.5.17-.03.52.36 1.01.42 1.08.06.07.72 1.13 1.74 1.54 1.02.41 1.02.28 1.25.26.23-.02.7-.28.79-.47.09-.19.09-.35.06-.47-.03-.12-.11-.17-.23-.23z"/>
                    </svg>
                    <span class="font-semibold">WhatsApp</span>
                    <span class="mr-auto text-sm text-green-600 font-bold">مراسلة / Chat</span>
                </a>
                <a href="mailto:info@juniorpaints.com" class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition duration-150">
                    <i data-lucide="mail" class="w-6 h-6 ml-3 text-red-600"></i>
                    <span class="font-semibold">info@juniorpaints.com</span>
                    <span class="mr-auto text-sm text-gray-500">بريد إلكتروني / Email</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 3. Color Detail Modal -->
    <div id="color-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 transform transition-transform duration-300 scale-95 md:scale-100" role="dialog" aria-modal="true" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-[#264765]">تفاصيل اللون / Color Details</h3>
                <button onclick="toggleModal('color-detail-modal')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4">
                <!-- Swatch is now much bigger -->
                <div id="detail-swatch" class="h-48 rounded-lg mb-4 border-4 border-gray-300 shadow-inner"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">الاسم العربي:</p>
                        <p id="detail-name-ar" class="text-lg font-bold text-gray-800"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">الاسم الإنجليزي:</p>
                        <p id="detail-name-en" class="text-lg font-bold text-gray-800"></p>
                    </div>
                </div>

                <!-- Color Usage Section -->
                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-2">استخدامات اللون / Color Usage:</p>
                    <div id="detail-usages" class="flex flex-wrap gap-2">
                        <!-- Usage tags will be injected here -->
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-1">وصف اللون / Description:</p>
                    <p id="detail-description" class="text-gray-700 leading-relaxed"></p>
                </div>
                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500 mb-1">رموز اللون / Color Codes:</p>
                    <div class="grid grid-cols-4 gap-2 text-sm text-center font-mono">
                        <div class="p-2 bg-gray-100 rounded">Company Code: <span id="detail-company-code" class="font-bold"></span></div>
                        <div class="p-2 bg-gray-100 rounded">HEX: <span id="detail-hex"></span></div>
                        <div class="p-2 bg-gray-100 rounded">RGB: <span id="detail-rgb"></span></div>
                        <div class="p-2 bg-gray-100 rounded">LAB: <span id="detail-lab"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Engineer Search Modal -->
    <div id="engineer-search-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 transform transition-transform duration-300 scale-95 md:scale-100" role="dialog" aria-modal="true" dir="rtl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-[#264765]">البحث عن أقرب لون للمهندسين / Engineer Color Search</h3>
                <button onclick="toggleModal('engineer-search-modal')" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <p class="text-sm text-gray-600 mb-6">أدخل رمز اللون باستخدام أحد الأنظمة أدناه للعثور على أقرب لونين من كتالوج Junior Paints.</p>

            <div class="space-y-6">
                <!-- HEX Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">رمز HEX (#RRGGBB)</label>
                    <input type="text" id="search-hex" placeholder="#349bca" maxlength="7" class="search-input-segment text-left" style="text-align: left;" />
                </div>

                <div class="border-t pt-4">
                    <!-- RGB Input -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">قيم RGB (أحمر، أخضر، أزرق)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="search-rgb-r" placeholder="R (0-255)" min="0" max="255" class="search-input-segment" />
                        <input type="number" id="search-rgb-g" placeholder="G (0-255)" min="0" max="255" class="search-input-segment" />
                        <input type="number" id="search-rgb-b" placeholder="B (0-255)" min="0" max="255" class="search-input-segment" />
                    </div>
                </div>

                <div class="border-t pt-4">
                    <!-- LAB Input -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">قيم LAB (السطوع، المحور الأخضر/الأحمر، المحور الأصفر/الأزرق)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="search-lab-l" placeholder="L (0-100)" min="0" max="100" class="search-input-segment" step="0.1" />
                        <input type="number" id="search-lab-a" placeholder="a (-100-100)" min="-100" max="100" class="search-input-segment" step="0.1" />
                        <input type="number" id="search-lab-b" placeholder="b (-100-100)" min="-100" max="100" class="search-input-segment" step="0.1" />
                    </div>
                </div>

                <button onclick="performEngineerSearch()" class="w-full bg-[#349bca] hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center">
                    <i data-lucide="search" class="w-5 h-5 ml-2"></i>
                    ابحث عن أقرب الألوان
                </button>
            </div>

            <div id="search-results" class="mt-6 border-t pt-4 hidden">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">أقرب نتيجتين / Closest 2 Results</h4>
                <div id="closest-colors-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Closest colors injected here -->
                </div>
            </div>
            <p id="search-error" class="mt-4 text-red-500 text-center hidden">
                خطأ في الإدخال. يرجى إدخال رمز لون صحيح في أحد الحقول الثلاثة.
            </p>
        </div>
    </div>


    <script>
        // --- DATA MOCKING (Junior Paints) ---
        const BRAND_COLOR = "#349bca";
        const SECONDARY_COLOR = "#264765";
        const MAX_COMPARISON_COLORS = 3; // Max 3 colors for comparison

        const PAINT_COLORS = [
            // Note: LAB values here are for simplified comparison purposes.
            { code: 'J001', name_en: 'Ocean Blue', name_ar: 'أزرق المحيط', hex: '#349bca', rgb: [52, 155, 202], lab: [63.2, 0.4, -30.0], usage: ['Interior', 'Metal'], family: 'Blue', description: 'لون أزرق هادئ وعميق يذكر بزرقة مياه المحيط، مثالي لغرف النوم والمساحات المفتوحة.' },
            { code: 'J002', name_en: 'Deep Teal', name_ar: 'التركوازي العميق', hex: '#264765', rgb: [38, 71, 101], lab: [30.1, -1.2, -18.0], usage: ['Interior', 'Specialty'], family: 'Blue', description: 'لون أزرق داكن بلمسة خضراء، يوحي بالفخامة والعمق، رائع للمكاتب والمناطق الرسمية.' },
            { code: 'J003', name_en: 'Desert Sand', name_ar: 'رمل الصحراء', hex: '#d9b380', rgb: [217, 179, 128], lab: [75.0, 7.8, 25.1], usage: ['Exterior', 'Wood'], family: 'Yellow', description: 'لون ترابي دافئ ومحايد، يوفر شعوراً بالراحة والاستقرار، ممتاز للمنازل الخارجية.' },
            { code: 'J004', name_en: 'Mint Green', name_ar: 'أخضر نعناع', hex: '#98c698', rgb: [152, 198, 152], lab: [75.9, -15.0, 15.0], usage: ['Interior'], family: 'Green', description: 'درجة فاتحة من الأخضر، منعشة ومريحة للعين، مثالية للمطابخ وغرف الأطفال.' },
            { code: 'J005', name_en: 'Sunset Orange', name_ar: 'برتقالي الغروب', hex: '#ff7f50', rgb: [255, 127, 80], lab: [64.0, 48.0, 45.0], usage: ['Exterior', 'Specialty'], family: 'Red', description: 'برتقالي حيوي وساطع يحاكي ألوان الغروب، يضيف طاقة وحيوية للمناطق الخارجية.' },
            { code: 'J006', name_en: 'Pebble Gray', name_ar: 'رمادي الحصى', hex: '#a6a6a6', rgb: [166, 166, 166], lab: [67.0, 0.0, 0.0], usage: ['Interior', 'Exterior', 'Metal'], family: 'Gray', description: 'رمادي محايد ومتوسط، يمثل أساساً قوياً للديكورات الحديثة، متعدد الاستخدامات.' },
            { code: 'J007', name_en: 'Royal Purple', name_ar: 'أرجواني ملكي', hex: '#6a0dad', rgb: [106, 13, 173], lab: [35.0, 60.0, -50.0], usage: ['Interior'], family: 'Purple', description: 'لون بنفسجي غني وعميق يدل على الفخامة والملكية، يستخدم عادة في غرف المعيشة أو لهجات الجدران.' },
            { code: 'J008', name_en: 'Pure White', name_ar: 'أبيض نقي', hex: '#ffffff', rgb: [255, 255, 255], lab: [100.0, 0.0, 0.0], usage: ['Interior', 'Exterior', 'Wood', 'Metal'], family: 'White', description: 'أبيض أساسي يضيء أي مساحة، لا غنى عنه للأسقف وفتح المساحات.' },
            { code: 'J009', name_en: 'Terracotta', name_ar: 'الآجر الطيني', hex: '#cc7752', rgb: [204, 119, 82], lab: [58.0, 30.0, 35.0], usage: ['Exterior', 'Wood'], family: 'Red', description: 'لون بني محمر ترابي، شائع في الديكورات المستوحاة من الطبيعة والجنوبية.' },
            { code: 'J010', name_en: 'Sky Light', name_ar: 'سماء فاتحة', hex: '#87ceeb', rgb: [135, 206, 235], lab: [80.0, -10.0, -35.0], usage: ['Interior'], family: 'Blue', description: 'أزرق فاتح ومهدئ، يشبه سماء الصباح، يبعث على الهدوء والسكينة في أي غرفة.' }
        ];

        // Bilingual Filter Data
        const ALL_USAGES_DATA = [
            { key: 'Interior', en: 'Interior Use', ar: 'استخدام داخلي' },
            { key: 'Exterior', en: 'Exterior Use', ar: 'استخدام خارجي' },
            { key: 'Wood', en: 'Wood Finishes', ar: 'تشطيبات خشبية' },
            { key: 'Metal', en: 'Metal Coatings', ar: 'طلاءات معدنية' },
            { key: 'Specialty', en: 'Specialty Effects', ar: 'تأثيرات خاصة' }
        ];
        
        // Dynamically get unique families
        const uniqueFamilies = [...new Set(PAINT_COLORS.map(c => c.family))].sort();
        const ALL_FAMILIES_DATA = uniqueFamilies.map(f => ({
            key: f,
            en: f + ' Family',
            ar: `عائلة ${f === 'Blue' ? 'الأزرق' : f === 'Yellow' ? 'الأصفر' : f === 'Green' ? 'الأخضر' : f === 'Red' ? 'الأحمر' : f === 'Gray' ? 'الرمادي' : f === 'Purple' ? 'الأرجواني' : f === 'White' ? 'الأبيض' : f}`
        }));


        // State variables
        let selectedColors = [];

        // --- UTILITY FUNCTIONS FOR COLOR CONVERSION (Needed for Engineer Search) ---

        const clamp = (num, min = 0, max = 1) => Math.min(Math.max(num, min), max);

        function rgbToXyz(r, g, b) {
            let R = r / 255;
            let G = g / 255;
            let B = b / 255;

            R = (R > 0.04045) ? Math.pow((R + 0.055) / 1.055, 2.4) : R / 12.92;
            G = (G > 0.04045) ? Math.pow((G + 0.055) / 1.055, 2.4) : G / 12.92;
            B = (B > 0.04045) ? Math.pow((B + 0.055) / 1.055, 2.4) : B / 12.92;

            const X = R * 0.4124 + G * 0.3576 + B * 0.1805;
            const Y = R * 0.2126 + G * 0.7152 + B * 0.0722;
            const Z = R * 0.0193 + G * 0.1192 + B * 0.9505;

            return [X * 100, Y * 100, Z * 100]; // Scale to 100
        }

        const REF_X = 95.047;
        const REF_Y = 100.000;
        const REF_Z = 108.883;

        const f = (t) => (t > Math.pow(6 / 29, 3)) ? Math.cbrt(t) : (t / 3) * Math.pow(29 / 6, 2) + (4 / 29);

        function xyzToLab(X, Y, Z) {
            X /= REF_X;
            Y /= REF_Y;
            Z /= REF_Z;

            const fX = f(X);
            const fY = f(Y);
            const fZ = f(Z);

            const L = 116 * fY - 16;
            const a = 500 * (fX - fY);
            const b = 200 * (fY - fZ);

            return [
                parseFloat(L.toFixed(1)),
                parseFloat(a.toFixed(1)),
                parseFloat(b.toFixed(1))
            ];
        }

        function rgb255ToLab(r, g, b) {
            const [X, Y, Z] = rgbToXyz(r, g, b);
            return xyzToLab(X, Y, Z);
        }

        function calculateDeltaE(lab1, lab2) {
            const [L1, a1, b1] = lab1;
            const [L2, a2, b2] = lab2;
            return Math.sqrt(
                Math.pow(L1 - L2, 2) +
                Math.pow(a1 - a2, 2) +
                Math.pow(b1 - b2, 2)
            );
        }

        function getUsageString(usageKey) {
            const usage = ALL_USAGES_DATA.find(u => u.key === usageKey);
            return usage ? `${usage.ar} / ${usage.en}` : usageKey;
        }

        function getUsageClass(usageKey) {
            switch(usageKey) {
                case 'Interior': return 'usage-interior';
                case 'Exterior': return 'usage-exterior';
                case 'Wood': return 'usage-wood';
                case 'Metal': return 'usage-metal';
                case 'Specialty': return 'usage-specialty';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        function getContrastColor(rgb) {
            const luminance = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
            return luminance > 0.5 ? SECONDARY_COLOR : '#ffffff'; 
        }


        // --- UI & APPLICATION LOGIC ---

        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.querySelector('div[role="dialog"]').style.transform = 'scale(1)';
                }, 10);
            } else {
                modal.style.opacity = '0';
                modal.querySelector('div[role="dialog"]').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300); 
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const familyFilter = document.getElementById('color-family-filter');
            familyFilter.innerHTML = `<option value="">-- الكل / All --</option>`;
            ALL_FAMILIES_DATA.forEach(family => {
                familyFilter.innerHTML += `<option value="${family.key}">${family.ar} / ${family.en}</option>`;
            });

            const usageFilter = document.getElementById('usage-filter');
            usageFilter.innerHTML = `<option value="">-- الكل / All --</option>`;
            ALL_USAGES_DATA.forEach(usage => {
                usageFilter.innerHTML += `<option value="${usage.key}">${usage.ar} / ${usage.en}</option>`;
            });

            renderColorGrid(PAINT_COLORS);
            updateComparisonBar(); 

            lucide.createIcons();
        });


        function renderColorGrid(colors) {
            const grid = document.getElementById('color-grid');
            const noResults = document.getElementById('no-results');
            grid.innerHTML = '';

            if (colors.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            noResults.classList.add('hidden');

            colors.forEach(color => {
                const isSelected = selectedColors.some(c => c.code === color.code);
                
                const swatch = document.createElement('div');
                swatch.className = 'flex flex-col items-center justify-start p-3 rounded-xl hover:shadow-xl transition duration-300 transform hover:scale-[1.02] bg-white border border-gray-200 cursor-pointer';
                // Open details modal when clicking the swatch container
                swatch.onclick = () => handleColorClick(color);

                swatch.innerHTML = `
                    <div class="color-swatch-large w-full" style="background-color: ${color.hex}; border: 1px solid #ddd;"></div>
                    <div class="mt-2 text-center w-full">
                        <p class="text-sm font-semibold text-gray-800">${color.name_ar}</p>
                        <p class="text-xs text-gray-500">${color.name_en}</p>
                        <p class="text-xs font-mono font-bold text-[#264765] mt-1">${color.code}</p>

                        <!-- Button to add/remove from comparison -->
                        <button onclick="event.stopPropagation(); addToComparison('${color.code}')" class="mt-2 text-xs font-semibold px-3 py-1 rounded-full transition ${isSelected ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-blue-100 text-[#349bca] hover:bg-blue-200'}">
                            <i data-lucide="${isSelected ? 'minus-circle' : 'plus'}" class="w-4 h-4 inline-block align-text-bottom ml-1"></i>
                            ${isSelected ? 'إزالة من المقارنة' : 'أضف للمقارنة'}
                        </button>
                    </div>
                `;
                grid.appendChild(swatch);
            });
            lucide.createIcons();
        }

        function applyFilters() {
            const family = document.getElementById('color-family-filter').value;
            const usage = document.getElementById('usage-filter').value;

            const filteredColors = PAINT_COLORS.filter(color => {
                const familyMatch = !family || color.family === family;
                const usageMatch = !usage || color.usage.includes(usage);
                return familyMatch && usageMatch;
            });

            renderColorGrid(filteredColors);
        }

        function handleColorClick(color) {
            document.getElementById('detail-swatch').style.backgroundColor = color.hex;
            document.getElementById('detail-name-ar').textContent = color.name_ar;
            document.getElementById('detail-name-en').textContent = color.name_en;
            document.getElementById('detail-description').textContent = color.description;
            
            const usageContainer = document.getElementById('detail-usages');
            usageContainer.innerHTML = '';
            color.usage.forEach(usageKey => {
                const usageElement = document.createElement('span');
                usageElement.className = `usage-tag ${getUsageClass(usageKey)}`;
                usageElement.textContent = getUsageString(usageKey);
                usageContainer.appendChild(usageElement);
            });

            document.getElementById('detail-company-code').textContent = color.code; 
            document.getElementById('detail-hex').textContent = color.hex.toUpperCase();
            document.getElementById('detail-rgb').textContent = `RGB(${color.rgb.join(', ')})`;
            document.getElementById('detail-lab').textContent = `LAB(${color.lab.join(', ')})`;

            toggleModal('color-detail-modal');
        }

        function addToComparison(colorCode) {
            const color = PAINT_COLORS.find(c => c.code === colorCode);
            if (!color) return;

            const existingIndex = selectedColors.findIndex(c => c.code === colorCode);
            
            if (existingIndex !== -1) {
                // If exists, remove it
                selectedColors.splice(existingIndex, 1);
                alertMessage('success', `تمت إزالة اللون ${color.name_ar} من المقارنة.`);
            } else {
                // If doesn't exist, add it (if space available)
                if (selectedColors.length < MAX_COMPARISON_COLORS) {
                    selectedColors.push(color);
                    alertMessage('success', `تمت إضافة اللون ${color.name_ar} إلى المقارنة.`);
                } else {
                    alertMessage('warning', `لا يمكن إضافة المزيد. الحد الأقصى للمقارنة هو ${MAX_COMPARISON_COLORS} ألوان.`);
                    return; 
                }
            }
            updateComparisonBar();
            // Re-render grid to update 'Add/Remove' buttons state
            applyFilters();
        }
        
        function clearComparison() {
            selectedColors = [];
            updateComparisonBar();
            applyFilters(); // Re-render grid buttons
            alertMessage('success', 'تم مسح شريط المقارنة بنجاح.');
        }

        function updateComparisonBar() {
            const container = document.getElementById('comparison-swatch-container');
            const placeholder = document.getElementById('comparison-placeholder');
            const comparisonBar = document.getElementById('comparison-bar');
            const clearBtn = document.getElementById('clear-comparison-btn');
            
            // Remove only the color swatches (elements that are not the placeholder)
            Array.from(container.children).forEach(child => {
                if (child.id !== 'comparison-placeholder') {
                    child.remove();
                }
            });

            if (selectedColors.length === 0) {
                // Hide comparison bar (transition up)
                comparisonBar.classList.remove('visible');
                // Show placeholder
                placeholder.classList.remove('hidden');
                clearBtn.disabled = true;
            } else {
                // Show comparison bar (transition down)
                comparisonBar.classList.add('visible');
                // Hide placeholder
                placeholder.classList.add('hidden');
                clearBtn.disabled = false;
            
                selectedColors.forEach(color => {
                    const item = document.createElement('div');
                    item.className = 'comparison-swatch relative overflow-hidden flex-1 group'; 
                    item.style.backgroundColor = color.hex;
                    
                    const textColor = getContrastColor(color.rgb);
                    const secondaryTextColor = (textColor === SECONDARY_COLOR) ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)';

                    item.innerHTML = `
                        <!-- Details cover the entire swatch area -->
                        <div class="comparison-details text-right font-semibold">
                            <!-- Name and Code -->
                            <p class="text-lg font-extrabold" style="color: ${textColor};">${color.name_ar}</p>
                            <p class="text-sm font-mono mt-1" style="color: ${secondaryTextColor};">(${color.code})</p>
                        </div>

                        <!-- NEW: Direct Remove Button on the swatch -->
                        <button 
                            onclick="event.stopPropagation(); addToComparison('${color.code}')" 
                            class="absolute top-3 right-3 p-1.5 rounded-full bg-red-600 hover:bg-red-800 transition duration-150 shadow-lg opacity-80 hover:opacity-100 z-20" 
                            title="إزالة اللون">
                            <i data-lucide="x" class="w-5 h-5 text-white"></i>
                        </button>
                    `;
                    container.appendChild(item);
                    // Attach click handler to the item itself (excluding the button) to open details modal
                    // We attach the handler to the element, but the inner button uses stopPropagation to prevent the modal from opening
                    item.onclick = () => handleColorClick(color);
                });
            }

            lucide.createIcons();
        }

        function alertMessage(type, message) {
            const container = document.getElementById('app');
            const existingAlert = document.getElementById('app-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'app-alert';
            alertDiv.className = `fixed top-2 right-4 p-4 rounded-lg shadow-2xl z-50 transition-all duration-300 transform translate-x-0 ${type === 'warning' ? 'bg-yellow-100 border-yellow-400 text-yellow-700' : 'bg-green-100 border-green-400 text-green-700'} border-l-4`;
            alertDiv.setAttribute('dir', 'rtl');
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'warning' ? 'alert-triangle' : 'check-circle'}" class="w-5 h-5 ml-2"></i>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(alertDiv);
            lucide.createIcons();

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        async function performEngineerSearch() {
            const resultsDiv = document.getElementById('search-results');
            const errorP = document.getElementById('search-error');
            const container = document.getElementById('closest-colors-container');

            errorP.classList.add('hidden');
            resultsDiv.classList.add('hidden');
            container.innerHTML = '';

            let targetLab = null;

            const hexInput = document.getElementById('search-hex').value.trim();
            if (hexInput) {
                let hex = hexInput.startsWith('#') ? hexInput.substring(1) : hexInput;
                if (hex.length === 6) {
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);
                    if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                        targetLab = rgb255ToLab(r, g, b);
                    }
                }
            }

            if (!targetLab) {
                const r = parseInt(document.getElementById('search-rgb-r').value);
                const g = parseInt(document.getElementById('search-rgb-g').value);
                const b = parseInt(document.getElementById('search-rgb-b').value);

                if (!isNaN(r) && r >= 0 && r <= 255 && !isNaN(g) && g >= 0 && g <= 255 && !isNaN(b) && b >= 0 && b <= 255) {
                    targetLab = rgb255ToLab(r, g, b);
                }
            }

            if (!targetLab) {
                const L = parseFloat(document.getElementById('search-lab-l').value);
                const a = parseFloat(document.getElementById('search-lab-a').value);
                const b = parseFloat(document.getElementById('search-lab-b').value);

                if (!isNaN(L) && L >= 0 && L <= 100 && !isNaN(a) && a >= -100 && a <= 100 && !isNaN(b) && b >= -100 && b <= 100) {
                    targetLab = [L, a, b];
                }
            }

            if (!targetLab) {
                errorP.classList.remove('hidden');
                return;
            }

            const distances = PAINT_COLORS.map(color => {
                let colorLab = color.lab || rgb255ToLab(...color.rgb);
                const deltaE = calculateDeltaE(targetLab, colorLab);
                return {
                    ...color,
                    deltaE: deltaE
                };
            });

            distances.sort((a, b) => a.deltaE - b.deltaE);
            const closestColors = distances.slice(0, 2);

            closestColors.forEach(color => {
                const resultItem = document.createElement('div');
                resultItem.className = 'p-4 rounded-xl shadow-md border-2 border-[#349bca] bg-white transition duration-300 hover:scale-[1.02] cursor-pointer';
                resultItem.onclick = () => handleColorClick(color);

                resultItem.innerHTML = `
                    <div class="h-12 rounded-lg mb-3 border border-gray-300 shadow-inner" style="background-color: ${color.hex};"></div>
                    <p class="text-sm font-bold text-gray-800">${color.name_ar} (${color.name_en})</p>
                    <p class="text-xs text-gray-500 mt-1">رمز: ${color.code} - HEX: ${color.hex}</p>
                    <p class="text-xs text-green-600 font-semibold mt-1">القرب (Delta E): ${color.deltaE.toFixed(2)}</p>
                `;
                container.appendChild(resultItem);
            });

            resultsDiv.classList.remove('hidden');
        }

    </script>
</body>
</html>
