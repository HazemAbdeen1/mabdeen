<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كتالوج ألوان جونيور بينتز - البحث والمقارنة</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل أيقونات Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* تعيين خط عربي يدعم Tailwind */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root {
            font-family: 'Cairo', sans-serif;
        }
        /* تصميم عام لعينات الألوان */
        .color-swatch {
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s;
            cursor: pointer;
        }
        .color-swatch:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            z-index: 10;
        }
        
        /* ------------------------------------------- */
        /* Fixes for Matcher Slots */
        /* ------------------------------------------- */
        /* Fix 1: Increased size for comparison slots (h-[120px]) */
        .matcher-slot-small {
            height: 120px; /* Custom size for bigger target */
            min-width: 96px;
            width: 33.333%; /* Ensure equal width on mobile */
            transition: background-color 0.2s ease, border-color 0.2s ease;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
            padding: 0; 
        }
        
        /* Ensure touching slots are perfectly aligned horizontally on mobile */
        .touching-slots {
            display: flex;
            width: 100%;
        }
        .touching-slots > div:not(:last-child) {
            border-left: none; /* Remove border between slots on RTL */
        }
        .touching-slots > div:first-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-top-right-radius: 0.5rem; /* Apply radius to the rightmost element in RTL */
            border-bottom-right-radius: 0.5rem;
        }
        .touching-slots > div:last-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-top-left-radius: 0.5rem; /* Apply radius to the leftmost element in RTL */
            border-bottom-left-radius: 0.5rem;
        }
        
        /* Ensure the middle slot has no radius */
        .touching-slots > div:nth-child(2) {
            border-radius: 0 !important;
        }

        .drag-over {
            border: 3px dashed #349bca !important;
            background-color: rgba(52, 155, 202, 0.1) !important;
        }
        .modal {
            transition: opacity 0.2s ease;
        }
        
        /* Style for the simulated dragged element on touch devices */
        #touch-drag-clone {
            position: fixed;
            pointer-events: none; /* Crucial: allows events to pass through */
            z-index: 9999;
            opacity: 0.85;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* Dimensions are set dynamically in JS */
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-0">

    <!-- شريط الإجراءات العلوي (Fixed Header) -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-extrabold text-[#264765] flex items-center">
                <span data-lucide="palette" class="w-7 h-7 ml-3 text-[#349bca]"></span>
                جونيور بينتز
            </h1>
            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <!-- معلومات التغطية -->
                <button onclick="window.toggleCoverageModal(true)" class="bg-[#349bca] text-white px-3 py-2 rounded-lg shadow-md hover:bg-opacity-90 transition-all text-sm font-medium flex items-center">
                    <span data-lucide="map-pin" class="w-4 h-4 ml-1"></span>
                    معلومات التغطية
                </button>
                <!-- التواصل معنا -->
                <button onclick="window.toggleContactModal(true)" class="bg-[#264765] text-white px-3 py-2 rounded-lg shadow-md hover:bg-opacity-90 transition-all text-sm font-medium flex items-center">
                    <span data-lucide="phone" class="w-4 h-4 ml-1"></span>
                    تواصل معنا
                </button>
            </div>
        </div>
    </header>

    <!-- حاوية المحتوى الرئيسي -->
    <div class="max-w-7xl mx-auto p-4 md:p-8 pt-4 lg:pt-8">
        
        <!-- قسم البحث المتقدم وفتح البوب اب للمهندسين -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h2 class="text-xl md:text-2xl font-bold text-[#349bca] mb-4 md:mb-0">البحث الفني ومطابقة الأكواد</h2>
                <button onclick="window.toggleAdvancedSearchModal(true)" class="bg-[#264765] text-white px-4 py-2 rounded-lg text-base font-bold hover:bg-opacity-90 transition-all flex items-center shadow-md">
                    <span data-lucide="search-check" class="w-5 h-5 ml-2"></span>
                    أداة البحث المتقدم للمهندسين
                </button>
            </div>
            <p class="text-gray-600 mt-2 text-sm">استخدم هذه الأداة لإيجاد أقرب تطابق لوني عبر إدخال أكواد RGB أو LAB أو HEX بدقة عالية. (يتم عرض أقرب لونين فقط).</p>
        </div>
        
        <!-- قسم أدوات المطابقة (Color Matcher) - أصبح ملتصقًا عند التمرير (Sticky) -->
        <div id="sticky-matcher-container" 
             class="lg:w-full p-4 mb-8 bg-white rounded-xl shadow-lg border border-gray-200 sticky top-20 z-30">
            <!-- top-20 (80px) ensures it sticks just below the fixed header -->
            <h3 class="text-lg font-bold text-[#264765] mb-3">مقارنة 3 ألوان (لأغراض التصميم)</h3>
            <div id="matcher-slots-container" class="lg:flex lg:space-x-4 rtl:space-x-reverse touching-slots">
                <!-- خانات المطابقة (3 فقط) - أصبحت أكبر (h-[120px]) -->
                <div id="matcher-slot-1" 
                    class="matcher-slot-small flex items-center justify-center border-4 border-dashed border-gray-300 bg-gray-100 p-2 text-center text-gray-500 font-semibold text-xs lg:w-full lg:rounded-lg"
                    ondrop="window.drop(event)" ondragover="window.allowDrop(event)" ondragleave="window.dragLeave(event)">
                    <span data-lucide="square-plus" class="w-4 h-4 ml-1"></span>
                    أسقط اللون هنا
                </div>
                <div id="matcher-slot-2" 
                    class="matcher-slot-small flex items-center justify-center border-4 border-dashed border-gray-300 bg-gray-100 p-2 text-center text-gray-500 font-semibold text-xs flex-grow lg:w-full lg:rounded-lg"
                    ondrop="window.drop(event)" ondragover="window.allowDrop(event)" ondragleave="window.dragLeave(event)">
                    <span data-lucide="square-plus" class="w-4 h-4 ml-1"></span>
                    أسقط اللون هنا
                </div>
                <div id="matcher-slot-3" 
                    class="matcher-slot-small flex items-center justify-center border-4 border-dashed border-gray-300 bg-gray-100 p-2 text-center text-gray-500 font-semibold text-xs lg:w-full lg:rounded-lg"
                    ondrop="window.drop(event)" ondragover="window.allowDrop(event)" ondragleave="window.dragLeave(event)">
                    <span data-lucide="square-plus" class="w-4 h-4 ml-1"></span>
                    أسقط اللون هنا
                </div>
            </div>
            <button onclick="window.clearAllMatchedColors()" class="w-full text-sm text-red-600 hover:text-red-800 transition font-medium mt-3 flex items-center justify-center">
                <span data-lucide="trash-2" class="w-4 h-4 ml-1"></span>
                إزالة كل الألوان
            </button>
        </div>

        <!-- قسم التصفية والكتالوج الرئيسي -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-[#349bca] mb-4">كتالوج ألوان جونيور بينتز</h2>
            <!-- شريط الفلترة المعدل (Multi-Usage, Color Family, Sort By) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                
                <!-- التصفية حسب عائلة اللون -->
                <div>
                    <label for="filter-family" class="block text-gray-700 font-medium text-sm">التصفية حسب العائلة:</label>
                    <select id="filter-family" class="w-full p-2 border border-gray-300 rounded-lg" onchange="window.filterAndRenderCatalog()">
                        <option value="">جميع العائلات</option>
                        <option value="أزرق">أزرق</option>
                        <option value="أحمر">أحمر</option>
                        <option value="أخضر">أخضر</option>
                        <option value="أصفر">أصفر</option>
                        <option value="محايد">محايد (Neutral)</option>
                    </select>
                </div>

                <!-- التصفية حسب الاستخدام (Multi-Select Checkboxes) -->
                <div class="col-span-2"> 
                    <label class="block text-gray-700 font-medium text-sm mb-1">التصفية حسب الاستخدامات:</label>
                    <div id="usage-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2 text-sm p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="usage-filter" value="داخلي" class="form-checkbox h-4 w-4 text-[#349bca] rounded border-gray-300" onchange="window.filterAndRenderCatalog()">
                            <span class="ml-1 mr-2 text-gray-700">داخلي (Interior)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="usage-filter" value="خارجي" class="form-checkbox h-4 w-4 text-[#349bca] rounded border-gray-300" onchange="window.filterAndRenderCatalog()">
                            <span class="ml-1 mr-2 text-gray-700">خارجي (Exterior)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="usage-filter" value="خشب" class="form-checkbox h-4 w-4 text-[#349bca] rounded border-gray-300" onchange="window.filterAndRenderCatalog()">
                            <span class="ml-1 mr-2 text-gray-700">خشب (Wood)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="usage-filter" value="معدن" class="form-checkbox h-4 w-4 text-[#349bca] rounded border-gray-300" onchange="window.filterAndRenderCatalog()">
                            <span class="ml-1 mr-2 text-gray-700">معدن (Metal)</span>
                        </label>
                    </div>
                </div>
                
                <!-- الترتيب حسب (Defalt Hex Asc) -->
                <div>
                    <label for="sort-by" class="block text-gray-700 font-medium text-sm">الترتيب حسب:</label>
                    <select id="sort-by" class="w-full p-2 border border-gray-300 rounded-lg" onchange="window.filterAndRenderCatalog()">
                        <option value="name_asc">الاسم (أ - ي)</option>
                        <option value="code_asc">كود الشركة (تصاعدي)</option>
                        <option value="hex_asc" selected>الهيكس (تصاعدي)</option> <!-- Default Sort -->
                    </select>
                </div>
            </div>
            
            <p class="text-gray-600 text-sm flex items-center justify-end mt-4">
                <span data-lucide="info" class="w-4 h-4 ml-1"></span> للسحب والإفلات على الجوال، اضغط مطولاً (أكثر من نصف ثانية) ثم اسحب.
            </p>

            <!-- حاوية عرض الألوان -->
            <div id="color-catalog" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mt-6">
                <p class="text-gray-500 col-span-full text-center">جاري تحميل الألوان...</p>
            </div>
            
            <p id="color-count-display" class="text-sm text-gray-500 mt-4 text-center"></p>

        </div>
    </div>
    
    <!-- النافذة المنبثقة: أداة البحث المتقدم للمهندسين -->
    <div id="advanced-search-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'advanced-search-modal') window.toggleAdvancedSearchModal(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-[#264765]">أداة البحث المتقدم للمهندسين</h3>
                <button onclick="window.toggleAdvancedSearchModal(false)" class="text-gray-500 hover:text-red-500 transition">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <div class="p-6 space-y-6">
                
                <!-- التحكم بالمدخلات -->
                <label for="color-type" class="block text-gray-700 font-medium">1. اختر صيغة الإدخال:</label>
                <select id="color-type" class="w-full p-3 border border-gray-300 rounded-lg text-lg" onchange="window.toggleSearchInputs()">
                    <option value="hex" selected>HEX (ستة عشرية)</option>
                    <option value="rgb">RGB (أحمر، أخضر، أزرق)</option>
                    <option value="lab">LAB (إضاءة، محور أخضر/أحمر، محور أزرق/أصفر)</option>
                </select>

                <div id="input-fields-container" class="space-y-4">
                    <!-- حقول إدخال HEX -->
                    <div id="hex-search-inputs" class="space-y-2">
                        <label class="block text-gray-700 font-medium">2. قيمة HEX (#RRGGBB):</label>
                        <input type="text" id="hex-input" class="w-full p-3 border border-gray-300 rounded-lg text-lg text-right font-mono uppercase" placeholder="مثل: 349BCA" maxlength="7" oninput="window.updateAdvancedSearchPreview()">
                    </div>
                    
                    <!-- حقول إدخال RGB (مخفية) -->
                    <div id="rgb-search-inputs" class="space-y-2 hidden">
                        <label class="block text-gray-700 font-medium">2. مكونات RGB (0-255):</label>
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <input type="number" id="rgb-r-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="0" max="255" placeholder="R" oninput="window.updateAdvancedSearchPreview()">
                            <input type="number" id="rgb-g-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="0" max="255" placeholder="G" oninput="window.updateAdvancedSearchPreview()">
                            <input type="number" id="rgb-b-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="0" max="255" placeholder="B" oninput="window.updateAdvancedSearchPreview()">
                        </div>
                    </div>

                    <!-- حقول إدخال LAB (مخفية) -->
                    <div id="lab-search-inputs" class="space-y-2 hidden">
                        <label class="block text-gray-700 font-medium">2. مكونات LAB (L:0-100, A/B:+-128):</label>
                        <div class="flex space-x-2 rtl:space-x-reverse">
                            <input type="number" id="lab-l-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="0" max="100" step="1" placeholder="L" oninput="window.updateAdvancedSearchPreview()">
                            <input type="number" id="lab-a-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="-128" max="128" step="1" placeholder="A" oninput="window.updateAdvancedSearchPreview()">
                            <input type="number" id="lab-b-input" class="w-1/3 p-3 border border-gray-300 rounded-lg text-lg text-center" min="-128" max="128" step="1" placeholder="B" oninput="window.updateAdvancedSearchPreview()">
                        </div>
                    </div>
                </div>
                
                <div id="search-error" class="text-red-500 font-medium mt-2 hidden"></div>

                <!-- المعاينة والبحث -->
                <div class="flex items-center space-x-4 rtl:space-x-reverse border-t pt-4">
                    <div id="input-color-preview" class="w-12 h-12 rounded-lg border-2 border-gray-300 flex-shrink-0" style="background-color: #f3f4f6;"></div>
                    <div>
                        <p class="text-sm font-bold">اللون المدخل:</p>
                        <p id="input-color-display" class="text-gray-600 font-mono text-xs">HEX / RGB / LAB</p>
                    </div>
                </div>
                
                <button onclick="window.findClosestColors()" class="w-full bg-[#349bca] text-white p-3 rounded-lg text-lg font-bold hover:bg-opacity-90 transition-all flex items-center justify-center">
                    <span data-lucide="ruler" class="w-5 h-5 ml-2"></span>
                    3. ابحث عن أقرب تطابقين (Delta E)
                </button>

                <!-- نتائج البحث -->
                <div id="results-container" class="min-h-[120px] bg-gray-100 p-4 rounded-lg">
                    <p class="text-gray-500 text-sm text-center">النتائج ستظهر هنا بعد البحث. (أقرب لونين)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- النافذة المنبثقة: تفاصيل اللون -->
    <div id="color-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'color-detail-modal') window.toggleColorDetailModal(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="p-6 border-b flex justify-between items-center bg-[#264765] text-white rounded-t-xl">
                <h3 id="detail-modal-title" class="text-2xl font-bold">تفاصيل اللون</h3>
                <button onclick="window.toggleColorDetailModal(false)" class="text-gray-300 hover:text-white transition">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            
            <!-- محتوى التفاصيل: الآن عمود واحد مع عينة أكبر (H-48) -->
            <div class="p-6 space-y-6">
                <!-- عينة اللون الأكبر (H-48) -->
                <div id="detail-color-swatch" class="h-48 w-full rounded-lg shadow-2xl border-4 border-white transform transition-all" style="background-color: #f3f4f6;"></div>
                
                <!-- جدول التفاصيل والأكواد -->
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h4 class="text-xl font-bold text-[#349bca] mb-4">بيانات الأكواد الفنية</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                        <p class="font-bold text-gray-700">الاسم العربي:</p>
                        <p id="detail-arabic-name" class="text-[#264765] font-extrabold text-right text-base"></p>
                        
                        <p class="font-bold text-gray-700">الاسم الإنجليزي:</p>
                        <p id="detail-english-name" class="text-gray-600 text-right"></p>

                        <p class="font-bold text-gray-700">كود الشركة:</p>
                        <p id="detail-company-code" class="text-gray-600 font-mono text-right"></p>
                        
                        <p class="font-bold text-gray-700">صيغة HEX:</p>
                        <p id="detail-hex" class="text-gray-600 font-mono text-right"></p>
                        
                        <p class="font-bold text-gray-700">صيغة RGB:</p>
                        <p id="detail-rgb" class="text-gray-600 font-mono text-right"></p>
                        
                        <p class="font-bold text-gray-700">صيغة LAB:</p>
                        <p id="detail-lab" class="text-gray-600 font-mono text-right"></p>

                        <p class="font-bold text-gray-700">الاستخدام:</p>
                        <p id="detail-usage" class="text-gray-600 text-right"></p>
                        
                        <p class="font-bold text-gray-700">عائلة اللون:</p>
                        <p id="detail-family" class="text-gray-600 text-right"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- النافذة المنبثقة: معلومات التغطية -->
    <div id="coverage-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'coverage-modal') window.toggleCoverageModal(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-y-auto max-h-[90vh] p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-[#349bca]">معلومات تغطية منتجات جونيور</h3>
                <button onclick="window.toggleCoverageModal(false)" class="text-gray-400 hover:text-gray-800 transition">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            <div class="space-y-6">
                <!-- دهانات مائية (Water Based) -->
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-600">
                    <h4 class="text-xl font-bold text-blue-800 mb-2 flex items-center"><span data-lucide="droplets" class="w-5 h-5 ml-2"></span> الدهانات المائية (Water-Based)</h4>
                    <p class="text-sm text-gray-700">مثل دهانات الأكريليك واللاتكس الداخلية والخارجية.</p>
                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pr-4">
                        <li>**التغطية النظرية (الوجه الأول):** 10 - 12 متر مربع لكل لتر.</li>
                        <li>**التغطية النظرية (الوجه الثاني):** 14 - 16 متر مربع لكل لتر (لأن السطح يصبح أقل امتصاصاً).</li>
                        <li>**نصيحة فنية:** يعتمد على نسبة التخفيف ونوع الرولة أو الفرشاة المستخدمة.</li>
                    </ul>
                </div>
                <!-- دهانات زيتية (Oil Based) -->
                <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-600">
                    <h4 class="text-xl font-bold text-yellow-800 mb-2 flex items-center"><span data-lucide="oil-can" class="w-5 h-5 ml-2"></span> الدهانات الزيتية (Oil-Based / Alkyd)</h4>
                    <p class="text-sm text-gray-700">مثل دهانات الأبواب والنوافذ والأسطح المعدنية.</p>
                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pr-4">
                        <li>**التغطية النظرية:** 12 - 14 متر مربع لكل لتر للوجه الواحد.</li>
                        <li>**المذيب:** تتطلب مذيبات خاصة (كالتنر أو النفط الأبيض) للتخفيف والتنظيف.</li>
                        <li>**نصيحة فنية:** توفر متانة عالية ومقاومة للماء على الأسطح الخشبية والمعدنية.</li>
                    </ul>
                </div>
                <!-- معجون / فيلر (Putty / Filler) -->
                <div class="p-4 bg-gray-100 rounded-lg border-l-4 border-gray-600">
                    <h4 class="text-xl font-bold text-gray-800 mb-2 flex items-center"><span data-lucide="blocks" class="w-5 h-5 ml-2"></span> المعجون / الفيلر (Putty)</h4>
                    <p class="text-sm text-gray-700">للتسوية وملء الفراغات والعيوب قبل تطبيق الدهان.</p>
                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pr-4">
                        <li>**التغطية النظرية:** 1.5 - 2 كيلوجرام لكل متر مربع (حسب سمك التطبيق وعيوب السطح).</li>
                        <li>**التطبيق:** يتم تطبيقه عادة بوجهين أو ثلاثة و يتطلب صنفره جيدة.</li>
                        <li>**نصيحة فنية:** يجب التأكد من جفاف المعجون تماماً قبل تطبيق الدهان الأساس (Primer).</li>
                    </ul>
                </div>
            </div>
            <p class="mt-6 text-xs text-gray-500 text-center">التغطية الفعلية قد تختلف بناءً على ظروف السطح، طريقة التطبيق، والتبديد.</p>
        </div>
    </div>
    
    <!-- النافذة المنبثقة: تواصل معنا -->
    <div id="contact-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target.id === 'contact-modal') window.toggleContactModal(false)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-y-auto max-h-[90vh] p-6 text-center" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-[#264765] mb-4">كيف يمكننا مساعدتك؟</h3>
            <p class="text-gray-600 mb-6">اختر طريقة التواصل الأنسب لك مع فريق دعم جونيور بينتز.</p>

            <div class="space-y-4">
                <!-- WhatsApp -->
                <a href="https://wa.me/966555123456" target="_blank" class="w-full flex items-center justify-center bg-green-500 text-white p-3 rounded-lg text-lg font-bold hover:bg-green-600 transition-all shadow-md">
                    <span data-lucide="message-square-text" class="w-6 h-6 ml-2"></span>
                    محادثة عبر الواتساب
                </a>
                <!-- Direct Call -->
                <a href="tel:+96612345678" class="w-full flex items-center justify-center bg-[#349bca] text-white p-3 rounded-lg text-lg font-bold hover:bg-[#267ba3] transition-all shadow-md">
                    <span data-lucide="phone" class="w-6 h-6 ml-2"></span>
                    اتصال هاتفي مباشر
                </a>
                <!-- Email -->
                <a href="mailto:info@juniorpaints.com" class="w-full flex items-center justify-center bg-gray-100 text-gray-800 p-3 rounded-lg text-lg font-bold hover:bg-gray-200 transition-all shadow-md">
                    <span data-lucide="mail" class="w-6 h-6 ml-2"></span>
                    إرسال بريد إلكتروني
                </a>
            </div>
            
            <button onclick="window.toggleContactModal(false)" class="text-sm text-gray-500 hover:text-gray-700 mt-6">إغلاق</button>
        </div>
    </div>


    <!-- منطق JavaScript الرئيسي -->
    <script>
        // تهيئة الأيقونات
        lucide.createIcons();

        // ==============================================
        //  بيانات الألوان الأولية (Junior Paints Only)
        // ==============================================
        const initialColors = [
            { id: 'c1', name: 'أزرق سماوي', englishName: 'Sky Blue', brand: 'Junior Paints', companyCode: 'JP-349', family: 'أزرق', usage: ['داخلي', 'خارجي'], hex: '#349bca', r: 52, g: 155, b: 202, l: 60.1, a: -12.3, bVal: -31.4 },
            { id: 'c2', name: 'أزرق ملكي', englishName: 'Royal Blue', brand: 'Junior Paints', companyCode: 'JP-264', family: 'أزرق', usage: ['خارجي', 'معدن'], hex: '#264765', r: 38, g: 71, b: 101, l: 30.2, a: 0.1, bVal: -17.6 },
            { id: 'c3', name: 'رمادي أساسي', englishName: 'Base Gray', brand: 'Junior Paints', companyCode: 'JP-C0C', family: 'محايد', usage: ['داخلي', 'خشب'], hex: '#C0C0C0', r: 192, g: 192, b: 192, l: 80.5, a: 0.0, bVal: 0.0 },
            { id: 'c4', name: 'أحمر قرمزي', englishName: 'Crimson Red', brand: 'Junior Paints', companyCode: 'JP-FF4', family: 'أحمر', usage: ['داخلي'], hex: '#FF4500', r: 255, g: 69, b: 0, l: 54.0, a: 66.4, bVal: 65.2 },
            { id: 'c5', name: 'أخضر عشبي', englishName: 'Grass Green', brand: 'Junior Paints', companyCode: 'JP-32C', family: 'أخضر', usage: ['خارجي'], hex: '#32CD32', r: 50, g: 205, b: 50, l: 76.6, a: -44.2, bVal: 74.3 },
            { id: 'c6', name: 'أصفر لامع', englishName: 'Bright Yellow', brand: 'Junior Paints', companyCode: 'JP-FFD', family: 'أصفر', usage: ['معدن'], hex: '#FFD700', r: 255, g: 215, b: 0, l: 90.7, a: -3.4, bVal: 91.0 },
            { id: 'c7', name: 'أزرق فاتح', englishName: 'Light Blue', brand: 'Junior Paints', companyCode: 'JP-87C', family: 'أزرق', usage: ['داخلي'], hex: '#87CEEB', r: 135, g: 206, b: 235, l: 80.5, a: -10.0, bVal: -27.0 },
            { id: 'c8', name: 'بنفسجي داكن', englishName: 'Dark Violet', brand: 'Junior Paints', companyCode: 'JP-4B0', family: 'أحمر', usage: ['خشب'], hex: '#4B0082', r: 75, g: 0, b: 130, l: 26.6, a: 40.5, bVal: -55.8 },
            { id: 'c9', name: 'برتقالي شمسي', englishName: 'Sun Orange', brand: 'Junior Paints', companyCode: 'JP-FFA', family: 'أصفر', usage: ['خارجي'], hex: '#FFA500', r: 255, g: 165, b: 0, l: 79.4, a: 24.3, bVal: 82.3 },
            { id: 'c10', name: 'بيج رملي', englishName: 'Sand Beige', brand: 'Junior Paints', companyCode: 'JP-D3D', family: 'محايد', usage: ['داخلي'], hex: '#D3D3D3', r: 211, g: 211, b: 211, l: 84.7, a: 0.0, bVal: 0.0 },
        ];
        
        // ==============================================
        //  آلة حالة اللمس (Touch State Machine) - (تحسين منع التمرير)
        // ==============================================
        let touchState = {
            id: null,
            startX: 0,
            startY: 0,
            startTime: 0,
            isDragging: false,
            cloneElement: null,
            longPressTimer: null
        };
        const LONG_PRESS_THRESHOLD = 500; // 500ms for drag initiation
        const DRAG_TOLERANCE = 10; // Pixel tolerance for recognizing movement as scroll vs. drag
        
        /**
         * تبدأ عملية اللمس.
         * تخزن الإحداثيات وتبدأ عداد الضغط المطول.
         */
        window.handleTouchStart = (event, colorId) => {
            // تجاهل اللمسات الإضافية أو إذا كان مؤقت التمرير نشطاً
            if (touchState.isDragging || touchState.longPressTimer) {
                // لا نمنع سلوك النقر هنا للسماح للنقرات العادية بالعمل
                return;
            }

            const touch = event.touches[0];
            if (!touch) return;

            // إعادة تعيين الحالة والتقاط البيانات الأولية
            touchState.id = colorId;
            touchState.startX = touch.clientX;
            touchState.startY = touch.clientY;
            touchState.startTime = Date.now();
            touchState.isDragging = false;
            
            // بدء مؤقت لبدء محاكاة السحب بعد الضغط المطول
            touchState.longPressTimer = setTimeout(() => {
                // إذا لم يتم إلغاء العداد بالحركة (touchmove)، نبدأ السحب
                if (touchState.id) {
                    startTouchDragSimulation(event.currentTarget, colorId, touch);
                }
            }, LONG_PRESS_THRESHOLD);
        };
        
        /**
         * تبدأ محاكاة السحب المرئي (بإنشاء عنصر وهمي).
         */
        const startTouchDragSimulation = (originalElement, colorId, touch) => {
            if (touchState.cloneElement) return; 
            
            const colorData = initialColors.find(c => c.id === colorId);
            if (!colorData) return;

            // 1. إنشاء العنصر الوهمي
            const clone = originalElement.cloneNode(true);
            clone.id = 'touch-drag-clone';
            
            // نسخ الحجم من العنصر الأصلي
            clone.style.width = originalElement.offsetWidth + 'px';
            clone.style.height = originalElement.offsetHeight + 'px';

            // إزالة الأحداث الأصلية من العنصر الوهمي
            clone.removeAttribute('ondragstart');
            clone.removeAttribute('ontouchstart');
            clone.onclick = (e) => e.preventDefault(); 

            document.body.appendChild(clone);
            
            // تحديث الحالة
            touchState.isDragging = true;
            touchState.cloneElement = clone;

            // تحديث الموضع الأولي
            clone.style.left = touch.clientX + 'px';
            clone.style.top = touch.clientY + 'px';
            
            // إظهار مناطق الإفلات المحتملة
            document.querySelectorAll('.matcher-slot-small').forEach(dz => {
                if (!dz.classList.contains('matcher-slot-filled')) {
                    dz.classList.add('drag-over');
                }
            });
        };


        /**
         * تتعقب حركة الأصبع. (محسن لمنع التمرير)
         */
        window.handleTouchMove = (event) => {
            const touch = event.touches[0];
            if (!touch || (!touchState.longPressTimer && !touchState.isDragging)) return;
            
            const dx = Math.abs(touch.clientX - touchState.startX);
            const dy = Math.abs(touch.clientY - touchState.startY);

            // 1. إذا كنا ننتظر الضغط المطول
            if (touchState.longPressTimer) {
                // إذا تجاوزت الحركة التسامح، فهي تمرير: نلغي السحب.
                if (dx > DRAG_TOLERANCE || dy > DRAG_TOLERANCE) {
                    clearTimeout(touchState.longPressTimer);
                    touchState.id = null; // إلغاء السحب المحتمل
                    // لا نمنع الافتراضي، مما يسمح للتمرير بالبدء.
                } else {
                    // حركة بسيطة جداً، نحن ننتظر السحب. نمنع التمرير مؤقتاً.
                    event.preventDefault(); 
                }
                return;
            }

            // 2. إذا بدأ السحب بالفعل: حرك العنصر الوهمي ومنع التمرير
            if (touchState.isDragging && touchState.cloneElement) {
                event.preventDefault(); // منع سلوك المتصفح الافتراضي (التمرير)
                // تحديث موقع العنصر الوهمي
                touchState.cloneElement.style.left = touch.clientX + 'px';
                touchState.cloneElement.style.top = touch.clientY + 'px';
            }
        };

        /**
         * تُطلق عند رفع الأصبع.
         */
        window.handleTouchEnd = (event) => {
            clearTimeout(touchState.longPressTimer);
            
            if (!touchState.isDragging) {
                // ليس سحباً (نقرة سريعة)
                resetTouchState();
                return;
            }
            
            // الآن تم التأكد من أنها عملية سحب
            const touch = event.changedTouches[0];
            if (touch) {
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                let dropped = false;

                // التحقق من الإفلات باستخدام Bounding Boxes (أكثر موثوقية على الجوال)
                document.querySelectorAll('.matcher-slot-small').forEach(dropZone => {
                    if (dropZone.classList.contains('matcher-slot-filled')) return; 

                    const rect = dropZone.getBoundingClientRect();

                    // التحقق مما إذا كانت إحداثيات اللمس داخل مستطيل منطقة الإفلات
                    if (touchX >= rect.left && touchX <= rect.right &&
                        touchY >= rect.top && touchY <= rect.bottom) {
                        
                        const colorData = initialColors.find(c => c.id === touchState.id);
                        if (colorData) {
                            window.matchColor(dropZone, colorData);
                            dropped = true;
                        }
                    }
                });
            }
            
            // تنظيف وإعادة تعيين حالة اللمس
            resetTouchState();
        };

        const resetTouchState = () => {
            // إزالة العنصر الوهمي إذا كان موجوداً
            if (touchState.cloneElement) {
                touchState.cloneElement.remove();
            }
            // إزالة التمييز من جميع مناطق الإفلات
            document.querySelectorAll('.matcher-slot-small').forEach(dz => {
                dz.classList.remove('drag-over');
            });
            
            // إعادة تعيين الحالة
            touchState.id = null;
            touchState.startX = 0;
            touchState.startY = 0;
            touchState.startTime = 0;
            touchState.isDragging = false;
            touchState.cloneElement = null;
            touchState.longPressTimer = null;
        };


        // ==============================================
        //  وظائف مساعدة لتحويل الألوان (مطلوبة للبحث المتقدم)
        // ==============================================

        const hexToRgb = (hex) => {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
        
        const rgbToLab = (r, g, b) => {
            let red = r / 255, green = g / 255, blue = b / 255;
            red = (red > 0.04045) ? Math.pow((red + 0.055) / 1.055, 2.4) : red / 12.92;
            green = (green > 0.04045) ? Math.pow((green + 0.055) / 1.055, 2.4) : green / 12.92;
            blue = (blue > 0.04045) ? Math.pow((blue + 0.055) / 1.055, 2.4) : blue / 12.92;

            red *= 100; green *= 100; blue *= 100;

            let X = red * 0.4124 + green * 0.3576 + blue * 0.1805;
            let Y = red * 0.2126 + green * 0.7152 + blue * 0.0722;
            let Z = red * 0.0193 + green * 0.1192 + blue * 0.9505;

            const refX = 95.047, refY = 100.000, refZ = 108.883;

            X /= refX; Y /= refY; Z /= refZ;

            const f = (t) => t > 0.008856 ? Math.pow(t, 1/3) : (7.787 * t) + 16/116;

            const fx = f(X), fy = f(Y), fz = f(Z);

            const L = (116 * fy) - 16;
            const A = 500 * (fx - fy);
            const B = 200 * (fy - fz);

            return { l: L, a: A, b: B };
        }

        const calculateDeltaE = (lab1, lab2) => {
            // Delta E 1976 (Euclidean distance)
            const dL = lab1.l - lab2.l;
            const dA = lab1.a - lab2.a;
            const dB = lab1.b - lab2.b;
            return Math.sqrt(dL * dL + dA * dA + dB * dB);
        };
        
        const isLight = (hex) => {
            const rgb = hexToRgb(hex);
            if (!rgb) return false;
            // Luminance check (YIQ method)
            const yiq = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            return yiq >= 128;
        };


        // ==============================================
        //  وظائف بناء واجهة المستخدم (Rendering)
        // ==============================================

        /**
         * إنشاء HTML لعينة لون واحدة.
         * (محدثة: تشمل الاسم العربي والإنجليزي في الواجهة الخارجية)
         */
        const createColorSwatchHTML = (color, distance = null) => {
            const textColor = isLight(color.hex) ? 'text-gray-900' : 'text-white';
            const shadowClass = isLight(color.hex) ? 'text-shadow-sm' : 'text-shadow-lg'; 
            
            let deltaEText = '';
            if (distance !== null) {
                deltaEText = `<p class="font-bold text-xs leading-tight mt-1">ΔE: ${distance.toFixed(2)}</p>`;
            }
            
            // عرض جميع الاستخدامات في عينة اللون
            const usageText = color.usage.join(' / ');

            return `
                <div 
                    class="color-swatch rounded-xl overflow-hidden shadow-md h-[150px] flex flex-col justify-end relative group"
                    style="background-color: ${color.hex};"
                    draggable="true"
                    ondragstart="window.drag(event, '${color.id}')"
                    ontouchstart="window.handleTouchStart(event, '${color.id}')"
                    onclick="window.showColorDetails('${color.id}')"
                    data-color-id="${color.id}"
                >
                    <div class="p-2 ${textColor} bg-black/50 text-right w-full">
                        <p class="font-bold text-sm ${shadowClass} leading-tight">${color.name}</p>
                        <p class="font-semibold text-xs opacity-90 leading-tight">${color.englishName}</p> <!-- الاسم الإنجليزي مضاف هنا -->
                        <p class="font-mono text-xs opacity-80 leading-tight">${color.companyCode} | ${color.hex}</p>
                        ${deltaEText}
                    </div>
                    <p class="absolute top-2 right-2 text-xs font-semibold px-2 py-1 rounded-full ${isLight(color.hex) ? 'bg-black/10 text-gray-900' : 'bg-white/20 text-white'}">${usageText}</p>
                </div>
            `;
        };

        /**
         * عرض الألوان في الكتالوج الرئيسي.
         */
        const renderCatalog = (colors) => {
            const catalogContainer = document.getElementById('color-catalog');
            const countDisplay = document.getElementById('color-count-display');
            
            if (colors.length === 0) {
                catalogContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center p-8">لا توجد ألوان مطابقة لمعايير التصفية المحددة.</p>';
            } else {
                let htmlContent = colors.map(color => createColorSwatchHTML(color)).join('');
                catalogContainer.innerHTML = htmlContent;
            }
            
            countDisplay.textContent = `تم عرض ${colors.length} لون من أصل ${initialColors.length}.`;
        };

        // ==============================================
        //  وظائف التصفية والفرز للكتالوج
        // ==============================================

        window.filterAndRenderCatalog = () => {
            const familyFilter = document.getElementById('filter-family').value;
            const sortBy = document.getElementById('sort-by').value;
            
            // جلب جميع خيارات الاستخدام المحددة
            const selectedUsages = Array.from(document.querySelectorAll('input[name="usage-filter"]:checked'))
                                       .map(checkbox => checkbox.value);

            let currentColors = [...initialColors];

            // 1. التصفية
            currentColors = currentColors.filter(color => {
                const familyMatch = !familyFilter || color.family === familyFilter;
                
                // منطق الفلترة المتعددة للاستخدام (OR logic)
                const usageMatch = selectedUsages.length === 0 || 
                                   selectedUsages.some(selectedU => color.usage.includes(selectedU));

                return usageMatch && familyMatch;
            });
            
            // 2. الفرز
            currentColors.sort((a, b) => {
                if (sortBy === 'name_asc') return a.name.localeCompare(b.name, 'ar');
                if (sortBy === 'code_asc') return a.companyCode.localeCompare(b.companyCode);
                if (sortBy === 'hex_asc') return a.hex.localeCompare(b.hex); 
                return 0;
            });

            renderCatalog(currentColors);
        };
        
        // ==============================================
        //  وظائف السحب والإفلات (Drag & Drop) - للمتصفحات العادية ومناطق الإفلات
        // ==============================================

        window.drag = (ev, colorId) => {
            ev.dataTransfer.setData("colorId", colorId);
        };

        window.allowDrop = (ev) => {
            ev.preventDefault();
            if (!ev.currentTarget.classList.contains('matcher-slot-filled')) {
                ev.currentTarget.classList.add('drag-over');
            }
        };

        window.dragLeave = (ev) => {
            ev.currentTarget.classList.remove('drag-over');
        };

        window.drop = (ev) => {
            ev.preventDefault();
            const dropZone = ev.currentTarget;
            dropZone.classList.remove('drag-over');

            if (dropZone.classList.contains('matcher-slot-filled')) {
                return;
            }

            const colorId = ev.dataTransfer.getData("colorId");
            const colorData = initialColors.find(c => c.id === colorId);

            if (colorData) {
                window.matchColor(dropZone, colorData);
            }
        };

        window.removeMatchedColor = (dropZoneId, event) => {
            if (event) event.stopPropagation();
            const dropZone = document.getElementById(dropZoneId);
            if (!dropZone) return;

            dropZone.innerHTML = `
                <span data-lucide="square-plus" class="w-4 h-4 ml-1"></span>
                أسقط اللون هنا
            `;
            lucide.createIcons(); 
            
            dropZone.classList.remove('matcher-slot-filled');
            // Re-add helper classes removed during matchColor
            dropZone.classList.add('flex', 'items-center', 'justify-center', 'p-2'); 
            dropZone.removeAttribute('data-color-data');
            dropZone.style.backgroundColor = '';
            dropZone.ondrop = (ev) => window.drop(ev);
            dropZone.ondragover = (ev) => window.allowDrop(ev);
            dropZone.ondragleave = (ev) => window.dragLeave(ev);
        };

        window.matchColor = (dropZone, data) => {
            const textColor = isLight(data.hex) ? 'text-gray-900' : 'text-white';
            const shadowClass = isLight(data.hex) ? 'drop-shadow-sm' : 'drop-shadow-lg';

            dropZone.ondrop = null; 
            dropZone.ondragover = null;
            dropZone.ondragleave = null;

            // Remove helper classes before filling content
            dropZone.classList.remove('flex', 'items-center', 'justify-center', 'p-2'); 

            dropZone.innerHTML = `
                <div class="w-full h-full flex flex-col justify-end items-end relative overflow-hidden rounded-lg" style="background-color: ${data.hex};">
                    <button class="absolute top-1 left-1 p-1 bg-black/30 ${textColor} rounded-full hover:bg-black/50 transition z-10" onclick="window.removeMatchedColor('${dropZone.id}', event)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                    <div class="mt-auto bg-black/60 ${textColor} p-1 rounded-tl-md text-right w-full">
                        <p class="font-bold text-[10px] ${shadowClass} leading-tight">${data.name}</p>
                        <p class="font-mono text-[8px] opacity-80 leading-tight">${data.companyCode}</p>
                    </div>
                </div>
            `;
            dropZone.classList.add('matcher-slot-filled');
            dropZone.dataset.colorData = JSON.stringify(data);
        };

        window.clearAllMatchedColors = () => {
            for (let i = 1; i <= 3; i++) {
                const dropZone = document.getElementById(`matcher-slot-${i}`);
                if (dropZone && dropZone.classList.contains('matcher-slot-filled')) {
                    window.removeMatchedColor(dropZone.id);
                }
            }
        };
        
        // ==============================================
        //  وظائف المودال (Popups)
        // ==============================================

        window.toggleAdvancedSearchModal = (show) => {
            const modal = document.getElementById('advanced-search-modal');
            modal.classList.toggle('hidden', !show);
        };
        
        window.toggleColorDetailModal = (show) => {
            const modal = document.getElementById('color-detail-modal');
            modal.classList.toggle('hidden', !show);
        };
        
        window.toggleCoverageModal = (show) => {
            const modal = document.getElementById('coverage-modal');
            modal.classList.toggle('hidden', !show);
        };
        
        window.toggleContactModal = (show) => {
            const modal = document.getElementById('contact-modal');
            modal.classList.toggle('hidden', !show);
        };

        window.showColorDetails = (colorId) => {
            // تجاهل النقر إذا كنا في وضع السحب
            if (touchState.isDragging || touchState.longPressTimer) {
                return;
            }
            
            const color = initialColors.find(c => c.id === colorId);
            if (!color) return;

            document.getElementById('detail-modal-title').textContent = `${color.name} (${color.companyCode})`;
            document.getElementById('detail-color-swatch').style.backgroundColor = color.hex;
            
            document.getElementById('detail-arabic-name').textContent = color.name;
            document.getElementById('detail-english-name').textContent = color.englishName;
            document.getElementById('detail-company-code').textContent = color.companyCode;
            document.getElementById('detail-hex').textContent = color.hex;
            document.getElementById('detail-rgb').textContent = `${color.r}, ${color.g}, ${color.b}`;
            document.getElementById('detail-lab').textContent = `L:${color.l.toFixed(1)}, A:${color.a.toFixed(1)}, B:${color.bVal.toFixed(1)}`;
            // عرض الاستخدام كمصفوفة مفصولة بفاصلة
            document.getElementById('detail-usage').textContent = color.usage.join(', ');
            document.getElementById('detail-family').textContent = color.family;

            window.toggleColorDetailModal(true);
        };

        // ==============================================
        //  منطق البحث المتقدم (ضمن المودال)
        // ==============================================

        window.toggleSearchInputs = () => {
            const type = document.getElementById('color-type').value;
            document.getElementById('hex-search-inputs').classList.add('hidden');
            document.getElementById('rgb-search-inputs').classList.add('hidden');
            document.getElementById('lab-search-inputs').classList.add('hidden');

            document.getElementById(`${type}-search-inputs`).classList.remove('hidden');
            
            window.updateAdvancedSearchPreview();
        };

        const getSearchTargetLab = (type) => {
            const errorElement = document.getElementById('search-error');
            errorElement.classList.add('hidden');
            let hexForPreview = null;
            let targetLab = null;
            let inputValues = ''; 

            try {
                if (type === 'hex') {
                    let hexInput = document.getElementById('hex-input').value.trim();
                    inputValues = hexInput; 
                    if (hexInput.startsWith('#')) hexInput = hexInput.substring(1);
                    if (!/^([0-9a-fA-F]{3}){1,2}$/.test(hexInput)) throw new Error("تنسيق HEX غير صالح.");
                    
                    const hex = `#${hexInput.toUpperCase()}`;
                    const rgbObj = hexToRgb(hex);
                    if (!rgbObj) throw new Error("فشل تحويل HEX.");
                    hexForPreview = hex;
                    targetLab = rgbToLab(rgbObj.r, rgbObj.g, rgbObj.b);
                    
                } else if (type === 'rgb') {
                    const r = parseInt(document.getElementById('rgb-r-input').value, 10);
                    const g = parseInt(document.getElementById('rgb-g-input').value, 10);
                    const b = parseInt(document.getElementById('rgb-b-input').value, 10);
                    
                    inputValues = `R:${r || '0'}, G:${g || '0'}, B:${b || '0'}`; 
                    if (isNaN(r) || isNaN(g) || isNaN(b) || r < 0 || r > 255 || g < 0 || g > 255 || b < 0 || b > 255) throw new Error("تنسيق RGB غير صالح (0-255).");
                    
                    const toHex = (c) => c.toString(16).padStart(2, '0');
                    hexForPreview = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
                    
                    targetLab = rgbToLab(r, g, b);

                } else if (type === 'lab') {
                    const l = parseFloat(document.getElementById('lab-l-input').value);
                    const a = parseFloat(document.getElementById('lab-a-input').value);
                    const bVal = parseFloat(document.getElementById('lab-b-input').value);
                    
                    inputValues = `L:${l || '0'}, A:${a || '0'}, B:${bVal || '0'}`; 
                    if (isNaN(l) || isNaN(a) || isNaN(bVal) || l < 0 || l > 100) throw new Error("تنسيق LAB غير صالح (L: 0-100).");
                    
                    // المعاينة البصرية غير متاحة لـ LAB
                    hexForPreview = '#e5e7eb'; // لون رمادي فاتح ثابت
                    targetLab = { l, a, b: bVal };
                }
            } catch (error) {
                errorElement.textContent = `خطأ: ${error.message}`;
                errorElement.classList.remove('hidden');
                return null;
            }
            
            return { lab: targetLab, hexForPreview, inputValues, type };
        };
        
        // Update preview to show the actual input values
        window.updateAdvancedSearchPreview = () => {
            const type = document.getElementById('color-type').value;
            const processedData = getSearchTargetLab(type);
            
            const previewElement = document.getElementById('input-color-preview');
            const displayElement = document.getElementById('input-color-display');

            // إزالة تنسيقات الرسائل السابقة
            previewElement.innerHTML = '';
            previewElement.classList.remove('flex', 'items-center', 'justify-center', 'text-center', 'p-1', 'border-red-500');
            
            if (!processedData) {
                previewElement.style.backgroundColor = 'transparent';
                displayElement.textContent = 'أدخل قيم اللون...';
                return;
            }
            
            const { hexForPreview, inputValues, type: processedType } = processedData;

            previewElement.style.backgroundColor = hexForPreview || '#f3f4f6';
            
            // Display the actual input values
            let label = processedType.toUpperCase();
            if (processedType === 'hex') label = 'HEX';

            displayElement.textContent = `${label}: ${inputValues}`;

            // إذا تم اختيار LAB، أظهر رسالة واضحة في المعاينة
            if (processedType === 'lab') {
                previewElement.classList.add('flex', 'items-center', 'justify-center', 'text-center', 'p-1');
                previewElement.innerHTML = '<span class="text-xs text-gray-500 font-bold leading-tight">معاينة LAB غير متاحة</span>';
            }
        };


        window.findClosestColors = () => {
            const type = document.getElementById('color-type').value;
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">جاري البحث عن الألوان...</p>';

            const processedData = getSearchTargetLab(type);

            if (!processedData || !processedData.lab) {
                resultsContainer.innerHTML = '<p class="text-red-500 text-sm text-center">الرجاء تصحيح مدخلات اللون أولاً.</p>';
                return;
            }
            
            const targetLab = processedData.lab;

            // منطق البحث اللوني المعتمد على خوارزمية Delta E (المسافة اللونية)
            const distances = initialColors.map(color => {
                const catalogLab = { l: color.l, a: color.a, b: color.bVal };
                const deltaE = calculateDeltaE(targetLab, catalogLab);
                return { color, distance: deltaE };
            });

            // فرز الألوان لتحديد الأقرب (الأقل في قيمة Delta E)
            distances.sort((a, b) => a.distance - b.distance);
            
            // عرض أقرب لونين فقط
            const closestColors = distances.slice(0, 2); 
            
            if (closestColors.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">لم يتم العثور على ألوان قريبة في الكتالوج.</p>';
                 return;
            }

            let htmlResults = '<div class="grid grid-cols-2 gap-4">';
            
            closestColors.forEach(item => {
                htmlResults += createColorSwatchHTML(item.color, item.distance);
            });

            htmlResults += '</div>';
            resultsContainer.innerHTML = htmlResults;
        };

        // ==============================================
        //  وظيفة التهيئة عند التحميل
        // ==============================================
        window.onload = () => {
            // ربط معالجات اللمس العامة (يجب أن يكون passive: false للتحكم في التمرير)
            // هذا أمر حيوي لإيقاف التمرير الأصلي للمتصفح أثناء السحب المطول
            document.addEventListener('touchmove', window.handleTouchMove, { passive: false });
            document.addEventListener('touchend', window.handleTouchEnd);
            document.addEventListener('touchcancel', window.handleTouchEnd); // لمعالجة الحالات التي يتم فيها إلغاء اللمس

            window.filterAndRenderCatalog(); 
            window.toggleSearchInputs();
        };
    </script>
</body>
</html>
